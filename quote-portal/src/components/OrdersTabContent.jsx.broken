import React, { useState, useEffect } from 'react'
import { useOrders, useOrderActions, useOrderStats, useOrderItems } from '../hooks/useOrders.js'
import AddOrderModal from './AddOrderModal.jsx'
import { getOrderWithItems, OrderItemsService, OrdersService, updateOrderStatusBasedOnItems } from '../lib/orders-service.js'
import OrderItemService from '../lib/order-item-service.js'

// Orders dashboard component with real data
function OrdersDashboard({ stats, loading }) {
  if (loading) {
    return (
      <section className="materials-dashboard">
        <div className="card">
          <h3>YÃ¼kleniyor...</h3>
          <p>...</p>
        </div>
      </section>
    )
  }

  return (
    <section className="materials-dashboard">
      <div className="card">
        <h3>AÃ§Ä±k SipariÅŸler</h3>
        <p>{stats.pendingOrders}</p>
      </div>
      <div className="card">
        <h3>Bu Ay Teslim</h3>
        <p>{stats.thisMonthOrders}</p>
      </div>
      <div className="card">
        <h3>KÄ±smi Teslimat</h3>
        <p className="warning">{stats.partialOrders}</p>
      </div>
    </section>
  )
}

// Orders filters component
function OrdersFilters({ 
  filters, 
  onFilterChange, 
  isExpanded, 
  onToggleExpanded, 
  resultsCount, 
  hasActiveFilters 
}) {
  const toggleExpanded = () => {
    onToggleExpanded(!isExpanded)
  }

  return (
    <section className="materials-filters">
      <div style={{ 
        display: 'flex', 
        alignItems: 'flex-start', 
        gap: '8px',
        width: '100%'
      }}>
        {/* Sol taraf - GeniÅŸletme butonu */}
        <div style={{
          paddingLeft: '4px',
          paddingTop: '20px',
          display: 'flex',
          alignItems: 'center',
          height: '100%',
          order: 1,
          flexDirection: 'column',
          gap: '4px'
        }}>
          <button
            onClick={toggleExpanded}
            style={{
              background: 'none',
              border: 'none',
              fontSize: '16px',
              cursor: 'pointer',
              padding: '2px',
              borderRadius: '2px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              width: '20px',
              height: '20px'
            }}
            title={isExpanded ? 'Filtreleri gizle' : 'Filtreleri gÃ¶ster'}
          >
            {isExpanded ? 'âˆ’' : '+'}
          </button>
          
          <div style={{
            fontSize: '10px',
            color: '#6b7280',
            textAlign: 'center',
            lineHeight: '1.2',
            fontWeight: '500'
          }}>
            {resultsCount} sipariÅŸ
          </div>
        </div>

        {/* Orta kÄ±sÄ±m - Ana arama ve butonlar */}
        <div style={{
          flex: 1,
          order: 2
        }}>
          <div className="filters-container">
            <div className="search-section">
              <div className="search-input-container">
                <input 
                  placeholder="SipariÅŸ numarasÄ± veya tedarikÃ§iye gÃ¶re ara..." 
                  className="search-input" 
                  type="text"
                  value={filters.search || ''}
                  onChange={(e) => onFilterChange('search', e.target.value)}
                />
                <span className="search-icon">ğŸ”</span>
              </div>
            </div>

            {/* GeniÅŸletilmiÅŸ filtreler */}
            {isExpanded && (
              <div className="expanded-filters" style={{
                marginTop: '12px',
                padding: '16px',
                background: '#f8f9fa',
                borderRadius: '6px',
                border: '1px solid #e5e7eb'
              }}>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                  gap: '16px'
                }}>
                  {/* Durum Filtresi */}
                  <div>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '6px', 
                      fontSize: '12px', 
                      fontWeight: '600',
                      color: '#374151'
                    }}>
                      SipariÅŸ Durumu
                    </label>
                    <select
                      value={filters.orderStatus || 'TÃ¼mÃ¼'}
                      onChange={(e) => onFilterChange('orderStatus', e.target.value === 'TÃ¼mÃ¼' ? '' : e.target.value)}
                      style={{
                        width: '100%',
                        padding: '6px 8px',
                        border: '1px solid #d1d5db',
                        borderRadius: '4px',
                        fontSize: '12px'
                      }}
                    >
                      <option value="TÃ¼mÃ¼">TÃ¼mÃ¼</option>
                      <option value="Taslak">Taslak</option>
                      <option value="Onay Bekliyor">Onay Bekliyor</option>
                      <option value="OnaylandÄ±">OnaylandÄ±</option>
                      <option value="KÄ±smi Teslimat">KÄ±smi Teslimat</option>
                      <option value="Yolda">Yolda</option>
                      <option value="TamamlandÄ±">TamamlandÄ±</option>
                      <option value="Teslim Edildi">Teslim Edildi</option>
                      <option value="Ä°ptal Edildi">Ä°ptal Edildi</option>
                    </select>
                  </div>

                  {/* Tarih Filtresi */}
                  <div>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '6px', 
                      fontSize: '12px', 
                      fontWeight: '600',
                      color: '#374151'
                    }}>
                      SipariÅŸ Tarihi
                    </label>
                    <select
                      value={filters.dateRange || 'TÃ¼mÃ¼'}
                      onChange={(e) => onFilterChange('dateRange', e.target.value === 'TÃ¼mÃ¼' ? '' : e.target.value)}
                      style={{
                        width: '100%',
                        padding: '6px 8px',
                        border: '1px solid #d1d5db',
                        borderRadius: '4px',
                        fontSize: '12px'
                      }}
                    >
                      <option value="TÃ¼mÃ¼">TÃ¼mÃ¼</option>
                      <option value="bugÃ¼n">BugÃ¼n</option>
                      <option value="bu-hafta">Bu Hafta</option>
                      <option value="bu-ay">Bu Ay</option>
                      <option value="son-3-ay">Son 3 Ay</option>
                    </select>
                  </div>
                </div>

                {/* Aktif filtre temizleme */}
                {hasActiveFilters && (
                  <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #e5e7eb' }}>
                    <button
                      onClick={() => {
                        onFilterChange('search', '');
                        onFilterChange('orderStatus', '');
                        onFilterChange('dateRange', '');
                      }}
                      style={{
                        padding: '4px 8px',
                        fontSize: '11px',
                        background: '#ef4444',
                        color: 'white',
                        border: 'none',
                        borderRadius: '3px',
                        cursor: 'pointer'
                      }}
                    >
                      Filtreleri Temizle
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  )
}

// Orders table component
function OrdersTable({
  orders,
  loading,
  error,
  title,
  variant = 'pending',
  tabCounts,
  onChangeTab,
  onOrderClick,
  onUpdateOrderStatus,
  actionLoading = false,
  emptyMessage = 'SipariÅŸ bulunamadÄ±'
}) {
  console.log('ğŸ” DEBUG OrdersTable: Rendering with', {
    loading,
    error: !!error,
    ordersCount: orders?.length || 0,
    variant,
    tabCounts
  });

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY'
    }).format(amount || 0)
  }

  const formatDate = (date) => {
    if (!date) return '-'
    const dateObj = date instanceof Date ? date : new Date(date)
    return dateObj.toLocaleDateString('tr-TR')
  }

  const getStatusColor = (status) => {
    const colors = {
      Taslak: '#6b7280',
      'Onay Bekliyor': '#f59e0b',
      'OnaylandÄ±': '#3b82f6',
      'KÄ±smi Teslimat': '#f97316',
      Yolda: '#6366f1',
      'Teslim Edildi': '#10b981',
      TamamlandÄ±: '#10b981',
      'Ä°ptal Edildi': '#ef4444'
    }
    return colors[status] || '#6b7280'
  }

  return (
    <section className="materials-table-section">
      {/* Tab Navigation - Always Render */}
      <div className="orders-tabs-container" style={{ marginBottom: '16px' }}>
        <div className="orders-tabs">
          <button
            className={`orders-tab ${variant === 'pending' ? 'active' : ''}`}
            onClick={() => onChangeTab('pending')}
            style={{
              padding: '8px 16px',
              border: 'none',
              background: variant === 'pending' ? '#3b82f6' : '#f3f4f6',
              color: variant === 'pending' ? 'white' : '#374151',
              borderRadius: '6px',
              cursor: 'pointer',
              fontWeight: '500',
              transition: 'all 0.2s ease'
            }}
          >
            Bekleyen SipariÅŸler ({tabCounts.pending || 0})
          </button>
          <button
            className={`orders-tab ${variant === 'completed' ? 'active' : ''}`}
            onClick={() => onChangeTab('completed')}
            style={{
              padding: '8px 16px',
              border: 'none',
              background: variant === 'completed' ? '#3b82f6' : '#f3f4f6',
              color: variant === 'completed' ? 'white' : '#374151',
              borderRadius: '6px',
              cursor: 'pointer',
              fontWeight: '500',
              transition: 'all 0.2s ease'
            }}
          >
            Tamamlanan SipariÅŸler ({tabCounts.completed || 0})
          </button>
        </div>
      </div>

      {/* Table Container - Always Render */}
      <div className="materials-table-container">
        <table className="materials-table">
          <thead>
            <tr>
              <th style={{ minWidth: '150px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  SipariÅŸ Kodu
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '150px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  TedarikÃ§i
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '120px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  Tarihi
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '120px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  Toplam
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '120px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  Durum
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
            </tr>
          </thead>
          <tbody>
            {error ? (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#ef4444' }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}>âš ï¸</div>
                    <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: '600', color: '#dc2626' }}>
                      Hata OluÅŸtu
                    </h3>
                    <p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>
                      {error}
                    </p>
                  </div>
                </td>
              </tr>
            ) : orders.length === 0 ? (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#6b7280' }}>
                    <div style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}>ğŸ“‹</div>
                    <h3 style={{ margin: '0 0 8px', fontSize: '18px', fontWeight: '600', color: '#374151' }}>
                      {emptyMessage}
                    </h3>
                    <p style={{ margin: 0, fontSize: '14px', color: '#6b7280' }}>
                      {variant === 'pending' 
                        ? 'Yeni sipariÅŸler eklendiÄŸinde burada gÃ¶rÃ¼necek'
                        : 'Tamamlanan sipariÅŸler burada listelenir'
                      }
                    </p>
                  </div>
                </td>
              </tr>
            ) : (
              orders.map((order) => (
                <tr key={order.id} style={{ cursor: 'pointer' }} onClick={() => onOrderClick(order)}>
                  <td>
                    <div style={{ fontWeight: '600', color: '#1f2937' }}>
                      {order.orderCode || order.id}
                    </div>
                  </td>
                  <td>
                    <div style={{ color: '#374151' }}>{order.supplierName || 'BelirtilmemiÅŸ'}</div>
                  </td>
                  <td>
                    <div style={{ color: '#6b7280' }}>{formatDate(order.orderDate)}</div>
                  </td>
                  <td>
                    <div style={{ fontWeight: '600', color: '#1f2937' }}>
                      {formatCurrency(order.totalAmount)}
                    </div>
                  </td>
                  <td>
                    <div
                      style={{
                        display: 'inline-block',
                        padding: '4px 8px',
                        borderRadius: '12px',
                        fontSize: '12px',
                        fontWeight: '500',
                        color: 'white',
                        background: getStatusColor(order.orderStatus)
                      }}
                    >
                      {order.orderStatus || 'Onay Bekliyor'}
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </section>
  )
}
            }}
          >
            <span style={{ fontSize: '11px', fontWeight: 600, color: '#1d4ed8' }}>
              {item.itemCode || item.lineId || `item-${String(index + 1).padStart(2, '0')}`}
            </span>
            <span
              style={{
                fontSize: '10px',
                fontWeight: 600,
                color: '#0f172a',
                background: '#e2e8f0',
                padding: '2px 8px',
                borderRadius: '999px',
                whiteSpace: 'nowrap'
              }}
            >
              {item.itemStatus || 'Onay Bekliyor'}
            </span>
          </div>
          <div
            style={{
              display: 'grid',
              gridTemplateColumns: '0.9fr 1.3fr auto',
              gap: '8px',
              fontSize: '11px',
              color: '#475569'
            }}
          >
            <div style={{ fontWeight: 600 }}>{item.materialCode || 'â€”'}</div>
            <div style={{ fontWeight: 500, color: '#111827' }}>{item.materialName || '-'}</div>
            <div style={{ textAlign: 'right', fontWeight: 600 }}>
              {item.quantity || 0} adet
            </div>
          </div>
        </div>
      ))}
    </div>
  )

  return (
    <section className="materials-table">
      {/* Tab Navigation - Always render */}
      <div className="materials-tabs">
        <div className="orders-tabs" style={{ display: 'flex', gap: '12px' }}>
          <button
            type="button"
            className={`tab-button${variant === 'pending' ? ' active' : ''}`}
            onClick={() => onChangeTab && onChangeTab('pending')}
          >
            Bekleyen SipariÅŸler
            <span className="tab-count">({tabCounts?.pending ?? 0})</span>
          </button>
          <button
            type="button"
            className={`tab-button${variant === 'completed' ? ' active' : ''}`}
            onClick={() => onChangeTab && onChangeTab('completed')}
          >
            Tamamlanan SipariÅŸler
            <span className="tab-count">({tabCounts?.completed ?? 0})</span>
          </button>
        </div>
      </div>

      {/* Table Container - Always render with structure */}
      <div className="table-container">
        <table>
          <thead>
            <tr>
              <th style={{ minWidth: '120px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  SipariÅŸ
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '160px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  TedarikÃ§i
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '220px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  Kalemler
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '100px', textAlign: 'right' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  Tutar
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
              <th style={{ minWidth: '120px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  Durum
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#6b7280' }}>
                    <div style={{
                      fontSize: '48px',
                      marginBottom: '16px',
                      opacity: 0.5
                    }}>â³</div>
                    <h3 style={{
                      margin: '0 0 8px 0',
                      fontSize: '18px',
                      fontWeight: '600',
                      color: '#374151'
                    }}>
                      SipariÅŸler yÃ¼kleniyor...
                    </h3>
                    <p style={{
                      margin: '0',
                      fontSize: '14px',
                      color: '#6b7280'
                    }}>
                      LÃ¼tfen bekleyin
                    </p>
                  </div>
                </td>
              </tr>
            ) : error ? (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#ef4444' }}>
                    <div style={{
                      fontSize: '48px',
                      marginBottom: '16px',
                      opacity: 0.5
                    }}>âš ï¸</div>
                    <h3 style={{
                      margin: '0 0 8px 0',
                      fontSize: '18px',
                      fontWeight: '600',
                      color: '#dc2626'
                    }}>
                      BaÄŸlantÄ± Problemi
                    </h3>
                    <p style={{
                      margin: '0 0 16px 0',
                      fontSize: '14px',
                      color: '#6b7280'
                    }}>
                      {error.includes && error.includes('timeout') ? 
                        'Sunucuya baÄŸlanÄ±lamadÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.' : 
                        `SipariÅŸler yÃ¼klenirken hata oluÅŸtu: ${error}`
                      }
                    </p>
                    <button 
                      onClick={() => window.location.reload()} 
                      style={{
                        padding: '8px 16px',
                        fontSize: '14px',
                        backgroundColor: '#3b82f6',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer'
                      }}
                    >
                      SayfayÄ± Yenile
                    </button>
                  </div>
                </td>
              </tr>
            ) : orders && orders.length > 0 ? (
              orders.map((order) => {
                const items = variant === 'pending' ? order.pendingItems : order.deliveredItems
                const relevantTotal = variant === 'pending' ? order.pendingTotal : order.deliveredTotal
                return (
                  <tr
                    key={order.id}
                    onClick={() => onOrderClick && onOrderClick(order)}
                    style={{ cursor: onOrderClick ? 'pointer' : 'default' }}
                  >
                    <td>
                      <div style={{ fontFamily: 'monospace', fontSize: '12px', fontWeight: 600 }}>
                        {order.orderCode || order.id}
                      </div>
                      <div style={{ fontSize: '11px', color: '#6b7280', marginTop: '2px' }}>
                        {formatDate(order.orderDate)}
                      </div>
                    </td>
                    <td>
                      <div style={{ fontWeight: 600, fontSize: '13px' }}>{order.supplierName}</div>
                      <div style={{ fontSize: '11px', color: '#6b7280' }}>{order.supplierId}</div>
                    </td>
                    <td style={{ paddingTop: '6px', paddingBottom: '6px' }}>
                      {items.length > 0 ? renderLineChips(items) : 
                        <span style={{ fontSize: '12px', color: '#6b7280', fontStyle: 'italic' }}>
                          Kalem bulunmuyor
                        </span>
                      }
                    </td>
                    <td style={{ textAlign: 'right', fontWeight: 600, paddingTop: '6px', paddingBottom: '6px' }}>
                      {formatCurrency(relevantTotal || order.totalAmount)}
                    </td>
                    <td style={{ paddingTop: '6px', paddingBottom: '6px' }}>
                      {onUpdateOrderStatus ? (
                        <select
                          value={order.orderStatus}
                          disabled={actionLoading}
                          onClick={(e) => e.stopPropagation()}
                          onChange={(e) => {
                            if (e.target.value && e.target.value !== order.orderStatus) {
                              onUpdateOrderStatus(order.id, e.target.value)
                            }
                          }}
                          style={{
                            padding: '6px 10px',
                            fontSize: '11px',
                            fontWeight: 600,
                            border: '1px solid rgba(148, 163, 184, 0.6)',
                            borderRadius: '10px',
                            background: getStatusColor(order.orderStatus),
                            color: '#fff',
                            cursor: 'pointer'
                          }}
                        >
                          {['Onay Bekliyor', 'OnaylandÄ±', 'Yolda', 'Teslim Edildi', 'Ä°ptal Edildi'].map(status => (
                            <option key={status} value={status}>{status}</option>
                          ))}
                        </select>
                      ) : (
                        <span
                          style={{
                            display: 'inline-block',
                            padding: '4px 8px',
                            borderRadius: '12px',
                            fontSize: '11px',
                            fontWeight: 600,
                            color: 'white',
                            backgroundColor: getStatusColor(order.orderStatus)
                          }}
                        >
                          {order.orderStatus}
                        </span>
                      )}
                    </td>
                  </tr>
                )
              })
            ) : (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#6b7280' }}>
                    <div style={{
                      fontSize: '48px',
                      marginBottom: '16px',
                      opacity: 0.5
                    }}>ğŸ“‹</div>
                    <h3 style={{
                      margin: '0 0 8px 0',
                      fontSize: '18px',
                      fontWeight: '600',
                      color: '#374151'
                    }}>
                      {emptyMessage}
                    </h3>
                    <p style={{
                      margin: '0',
                      fontSize: '14px',
                      color: '#6b7280'
                    }}>
                      {variant === 'pending' 
                        ? 'Yeni sipariÅŸler eklendiÄŸinde burada gÃ¶rÃ¼necek'
                        : 'Teslim edilen sipariÅŸler burada gÃ¶rÃ¼nÃ¼r'
                      }
                    </p>
                  </div>
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </section>
  )
}
              <th style={{ minWidth: '120px' }}>
                <button type="button" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', background: 'none', border: 'none', cursor: 'pointer', padding: 0 }}>
                  Durum
                  <span style={{ fontSize: '12px', opacity: 0.6 }}>â†•</span>
                </button>
              </th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#6b7280' }}>
                    <div style={{
                      fontSize: '48px',
                      marginBottom: '16px',
                      opacity: 0.5
                    }}>â³</div>
                    <h3 style={{
                      margin: '0 0 8px 0',
                      fontSize: '18px',
                      fontWeight: '600',
                      color: '#374151'
                    }}>
                      SipariÅŸler yÃ¼kleniyor...
                    </h3>
                    <p style={{
                      margin: '0',
                      fontSize: '14px',
                      color: '#6b7280'
                    }}>
                      LÃ¼tfen bekleyin
                    </p>
                  </div>
                </td>
              </tr>
            ) : error ? (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#ef4444' }}>
                    <div style={{
                      fontSize: '48px',
                      marginBottom: '16px',
                      opacity: 0.5
                    }}>âš ï¸</div>
                    <h3 style={{
                      margin: '0 0 8px 0',
                      fontSize: '18px',
                      fontWeight: '600',
                      color: '#dc2626'
                    }}>
                      BaÄŸlantÄ± Problemi
                    </h3>
                    <p style={{
                      margin: '0 0 16px 0',
                      fontSize: '14px',
                      color: '#6b7280'
                    }}>
                      {error.includes && error.includes('timeout') ? 
                        'Sunucuya baÄŸlanÄ±lamadÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.' : 
                        `SipariÅŸler yÃ¼klenirken hata oluÅŸtu: ${error}`
                      }
                    </p>
                    <button 
                      onClick={() => window.location.reload()} 
                      style={{
                        padding: '8px 16px',
                        fontSize: '14px',
                        backgroundColor: '#3b82f6',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer'
                      }}
                    >
                      SayfayÄ± Yenile
                    </button>
                  </div>
                </td>
              </tr>
            ) : orders && orders.length > 0 ? (
              orders.map((order) => {
                const items = variant === 'pending' ? order.pendingItems : order.deliveredItems
                const relevantTotal = variant === 'pending' ? order.pendingTotal : order.deliveredTotal
                return (
                  <tr
                    key={order.id}
                    onClick={() => onOrderClick && onOrderClick(order)}
                    style={{ cursor: onOrderClick ? 'pointer' : 'default' }}
                  >
                    <td>
                      <div style={{ fontFamily: 'monospace', fontSize: '12px', fontWeight: 600 }}>
                        {order.orderCode || order.id}
                      </div>
                      <div style={{ fontSize: '11px', color: '#6b7280', marginTop: '2px' }}>
                        {formatDate(order.orderDate)}
                      </div>
                    </td>
                    <td>
                      <div style={{ fontWeight: 600, fontSize: '13px' }}>{order.supplierName}</div>
                      <div style={{ fontSize: '11px', color: '#6b7280' }}>{order.supplierId}</div>
                    </td>
                    <td style={{ paddingTop: '6px', paddingBottom: '6px' }}>
                      {items.length > 0 ? renderLineChips(items) : 
                        <span style={{ fontSize: '12px', color: '#6b7280', fontStyle: 'italic' }}>
                          Kalem bulunmuyor
                        </span>
                      }
                    </td>
                    <td style={{ textAlign: 'right', fontWeight: 600, paddingTop: '6px', paddingBottom: '6px' }}>
                      {formatCurrency(relevantTotal || order.totalAmount)}
                    </td>
                    <td style={{ paddingTop: '6px', paddingBottom: '6px' }}>
                      {onUpdateOrderStatus ? (
                        <select
                          value={order.orderStatus}
                          disabled={actionLoading}
                          onClick={(e) => e.stopPropagation()}
                          onChange={(e) => {
                            if (e.target.value && e.target.value !== order.orderStatus) {
                              onUpdateOrderStatus(order.id, e.target.value)
                            }
                          }}
                          style={{
                            padding: '6px 10px',
                            fontSize: '11px',
                            fontWeight: 600,
                            border: '1px solid rgba(148, 163, 184, 0.6)',
                            borderRadius: '10px',
                            background: getStatusColor(order.orderStatus),
                            color: '#fff',
                            cursor: 'pointer'
                          }}
                        >
                          {['Onay Bekliyor', 'OnaylandÄ±', 'Yolda', 'Teslim Edildi', 'Ä°ptal Edildi'].map(status => (
                            <option key={status} value={status}>{status}</option>
                          ))}
                        </select>
                      ) : (
                        <span
                          style={{
                            display: 'inline-block',
                            padding: '4px 8px',
                            borderRadius: '12px',
                            fontSize: '11px',
                            fontWeight: 600,
                            color: 'white',
                            backgroundColor: getStatusColor(order.orderStatus)
                          }}
                        >
                          {order.orderStatus}
                        </span>
                      )}
                    </td>
                  </tr>
                )
              })
            ) : (
              <tr>
                <td colSpan={5} style={{ textAlign: 'center', padding: '40px 20px' }}>
                  <div style={{ color: '#6b7280' }}>
                    <div style={{
                      fontSize: '48px',
                      marginBottom: '16px',
                      opacity: 0.5
                    }}>ğŸ“‹</div>
                    <h3 style={{
                      margin: '0 0 8px 0',
                      fontSize: '18px',
                      fontWeight: '600',
                      color: '#374151'
                    }}>
                      {emptyMessage}
                    </h3>
                    <p style={{
                      margin: '0',
                      fontSize: '14px',
                      color: '#6b7280'
                    }}>
                      {variant === 'pending' 
                        ? 'Yeni sipariÅŸler eklendiÄŸinde burada gÃ¶rÃ¼necek'
                        : 'Teslim edilen sipariÅŸler burada gÃ¶rÃ¼nÃ¼r'
                      }
                    </p>
                  </div>
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </section>
  )
}

export default function OrdersTabContent() {
  console.log('ğŸš€ğŸš€ğŸš€ OrdersTabContent RENDER edildi!');
  
  const [activeOrdersTab, setActiveOrdersTab] = useState('pending') // 'pending' or 'completed'
  const [isAddOrderModalOpen, setIsAddOrderModalOpen] = useState(false)
  const [selectedOrder, setSelectedOrder] = useState(null)
  const [selectedOrderLoading, setSelectedOrderLoading] = useState(false)
  const [selectedOrderError, setSelectedOrderError] = useState(null)
  const [isFiltersExpanded, setIsFiltersExpanded] = useState(false)
  
  // Debug modal state
  useEffect(() => {
    console.log('ğŸ”¥ğŸ”¥ğŸ”¥ OrdersTabContent: Modal state deÄŸiÅŸti:', isAddOrderModalOpen);
  }, [isAddOrderModalOpen])
  
  // Filter state
  const [filters, setFilters] = useState({
    search: '',
    orderStatus: '',
    dateRange: ''
  })

  // Firebase hooks
  const { stats, loading: statsLoading } = useOrderStats()
  const { updateOrder, loading: actionLoading } = useOrderActions()
  const { orders, loading: ordersLoading, error: ordersError, refreshOrders } = useOrders({}, { autoLoad: true, realTime: false })

  console.log('ğŸ” DEBUG OrdersTabContent HOOKS:', {
    ordersCount: orders?.length || 0,
    ordersLoading,
    ordersError: !!ordersError,
    ordersErrorMessage: ordersError,
    statsLoading,
    actionLoading
  });

  // Improved Firebase error detection
  const hasFirebaseError = !!(ordersError && (
    typeof ordersError === 'string' && (
      ordersError.includes('Firebase') || 
      ordersError.includes('firestore') ||
      ordersError.includes('CollectionReference') ||
      ordersError.includes('access control checks') ||
      ordersError.includes('CORS') ||
      ordersError.includes('aÄŸ baÄŸlantÄ±sÄ±') ||
      ordersError.includes('baÄŸlantÄ± problemi')
    )
  ));

  // Show empty state with error message but keep UI structure visible
  const isInOfflineMode = hasFirebaseError || !orders || orders.length === 0;

  console.log('ğŸ” DEBUG: Firebase error detected:', hasFirebaseError);
  console.log('ğŸ” DEBUG: Offline mode active:', isInOfflineMode);

  const ORDER_STATUS_OPTIONS = ['Onay Bekliyor', 'OnaylandÄ±', 'Yolda', 'Teslim Edildi', 'Ä°ptal Edildi']
  const ITEM_STATUS_OPTIONS = ['Onay Bekliyor', 'OnaylandÄ±', 'Yolda', 'Teslim Edildi', 'Ä°ptal Edildi']
  const [updatingItemIds, setUpdatingItemIds] = useState([])

  // Filter change handler
  const handleFilterChange = (key, value) => {
    console.log('ğŸ” Order Filter deÄŸiÅŸti:', key, '=', value);
    setFilters(prev => ({ ...prev, [key]: value }));
  }

  // Check if filters are active
  const hasActiveFilters = () => {
    return !!(filters.search || filters.orderStatus || filters.dateRange);
  }

  // Apply filters to orders
  const applyFilters = (orders) => {
    if (!orders) return [];

    return orders.filter(order => {
      // Search filter
      if (filters.search) {
        const searchLower = filters.search.toLowerCase();
        const matches = 
          (order.orderCode || order.id).toLowerCase().includes(searchLower) ||
          order.supplierName?.toLowerCase().includes(searchLower) ||
          order.supplierId?.toLowerCase().includes(searchLower);
        
        if (!matches) return false;
      }

      // Status filter
      if (filters.orderStatus && order.orderStatus !== filters.orderStatus) {
        return false;
      }

      // Date range filter
      if (filters.dateRange && order.orderDate) {
        const orderDate = order.orderDate instanceof Date ? order.orderDate : new Date(order.orderDate);
        const now = new Date();
        
        switch (filters.dateRange) {
          case 'bugÃ¼n':
            if (orderDate.toDateString() !== now.toDateString()) return false;
            break;
          case 'bu-hafta':
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            if (orderDate < weekStart) return false;
            break;
          case 'bu-ay':
            if (orderDate.getMonth() !== now.getMonth() || orderDate.getFullYear() !== now.getFullYear()) return false;
            break;
          case 'son-3-ay':
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            if (orderDate < threeMonthsAgo) return false;
            break;
        }
      }

      return true;
    });
  }

  const filteredOrders = applyFilters(orders);

  console.log('ğŸ” DEBUG OrdersTabContent: Total orders:', orders.length);
  console.log('ğŸ” DEBUG OrdersTabContent: Filtered orders:', filteredOrders.length);
  console.log('ğŸ” DEBUG OrdersTabContent: Stats:', stats);
  console.log('ğŸ” DEBUG OrdersTabContent: Orders loading:', ordersLoading);
  console.log('ğŸ” DEBUG OrdersTabContent: Orders error:', ordersError);

  const enhancedOrders = filteredOrders.map(order => {
    const items = Array.isArray(order.items) ? order.items : [];
    const pendingItems = items.filter(item => item.itemStatus !== 'Teslim Edildi');
    const deliveredItems = items.filter(item => item.itemStatus === 'Teslim Edildi');
    const pendingTotal = pendingItems.reduce((sum, item) => sum + (item.quantity || 0) * (item.unitPrice || 0), 0);
    const deliveredTotal = deliveredItems.reduce((sum, item) => sum + (item.quantity || 0) * (item.unitPrice || 0), 0);
    
    console.log(`ğŸ” DEBUG Order ${order.orderCode || order.id}: `, {
      orderStatus: order.orderStatus,
      totalItems: items.length,
      pendingItems: pendingItems.length,
      deliveredItems: deliveredItems.length,
      items: items.map(item => ({ code: item.materialCode, status: item.itemStatus }))
    });
    
    return {
      ...order,
      pendingItems,
      deliveredItems,
      pendingTotal,
      deliveredTotal
    };
  });

  const pendingOrdersView = enhancedOrders.filter(order => {
    // Show in pending if:
    // 1. Order status is NOT completed/delivered, AND
    // 2. Order has items that are not delivered yet
    const isOrderCompleted = ['Teslim Edildi', 'TamamlandÄ±'].includes(order.orderStatus);
    return !isOrderCompleted && order.pendingItems.length > 0;
  });
  
  const completedOrdersView = enhancedOrders.filter(order => {
    // Show in completed if:
    // 1. Order status is completed/delivered, OR  
    // 2. All items are delivered (even if order status not yet updated)
    const isOrderCompleted = ['Teslim Edildi', 'TamamlandÄ±'].includes(order.orderStatus);
    return isOrderCompleted || (order.totalItems > 0 && order.pendingItems.length === 0);
  });

  console.log('ğŸ” DEBUG OrdersTabContent: Enhanced orders:', enhancedOrders.length);
  console.log('ğŸ” DEBUG OrdersTabContent: Pending orders view:', pendingOrdersView.length);
  console.log('ğŸ” DEBUG OrdersTabContent: Completed orders view:', completedOrdersView.length);
  console.log('ğŸ” DEBUG OrdersTabContent: Active tab:', activeOrdersTab);

  const currentOrders = activeOrdersTab === 'pending' ? pendingOrdersView : completedOrdersView;
  const currentLoading = ordersLoading;

  console.log('ğŸ” DEBUG OrdersTabContent: Current orders for table:', currentOrders.length);

  const serializeItemsForOrder = (list = []) => (
    list.map(item => {
      const fallbackLineId = item.lineId || `${item.materialCode || item.itemCode || item.id}-${String(item.itemSequence || 1).padStart(2, '0')}`
      return {
        id: item.id,
        lineId: fallbackLineId,
        itemCode: item.itemCode,
        itemSequence: item.itemSequence,
        materialCode: item.materialCode,
        materialName: item.materialName,
        quantity: item.quantity,
        unitPrice: item.unitPrice,
        itemStatus: item.itemStatus,
        expectedDeliveryDate: item.expectedDeliveryDate instanceof Date
          ? item.expectedDeliveryDate
          : (item.expectedDeliveryDate || null),
        actualDeliveryDate: item.actualDeliveryDate instanceof Date
          ? item.actualDeliveryDate
          : (item.actualDeliveryDate || null)
      }
    })
  )

  // Handle order click
  const handleOrderClick = async (order) => {
    console.log('ğŸ“‹ SipariÅŸ detayÄ± aÃ§Ä±lÄ±yor:', order);
    setUpdatingItemIds([])
    setSelectedOrderLoading(true)
    setSelectedOrderError(null)
    setSelectedOrder({ ...order, items: order.items || [] })
    try {
      const detailedOrder = await getOrderWithItems(order.id)
      setSelectedOrder(detailedOrder)
    } catch (error) {
      console.error('âŒ SipariÅŸ detayÄ± yÃ¼klenirken hata:', error)
      setSelectedOrderError(error.message)
      setSelectedOrder(prev => prev || order)
    } finally {
      setSelectedOrderLoading(false)
    }
  }

  const handleCloseOrderDetail = () => {
    setSelectedOrder(null)
    setSelectedOrderError(null)
    setSelectedOrderLoading(false)
    setUpdatingItemIds([])
  }

  // Handle order status update
  const handleUpdateOrderStatus = async (orderId, newStatus) => {
    if (!newStatus) return;
    if (selectedOrder && selectedOrder.id === orderId && selectedOrder.orderStatus === newStatus) {
      return;
    }
    try {
      // Single call to updateOrder which handles both status and stock updates internally
      const updatedOrder = await updateOrder(orderId, { orderStatus: newStatus });

      // Update local state
      if (selectedOrder && selectedOrder.id === orderId) {
        setSelectedOrder(prev => prev ? {
          ...prev,
          orderStatus: newStatus,
          items: updatedOrder.items || prev.items
        } : prev)
      }
      
      await refreshOrders();

      if (selectedOrder && selectedOrder.id === orderId) {
        setSelectedOrderLoading(true);
        try {
          const refreshed = await getOrderWithItems(orderId);
          setSelectedOrder(refreshed);
        } catch (detailError) {
          console.error('âŒ Detay gÃ¼ncellenirken hata:', detailError);
        } finally {
          setSelectedOrderLoading(false);
        }
      }

      console.log(`âœ… Order ${orderId} status updated to ${newStatus}`);
    } catch (error) {
      console.error('âŒ Error updating order status:', error);
    }
  }

  const handleItemStatusChange = async (orderId, item, newStatus) => {
    // Use lineId as the primary identifier, fallback to id if needed
    const itemIdentifier = item.lineId || item.itemCode || item.id;
    
    if (!itemIdentifier || !newStatus || newStatus === item.itemStatus) {
      return
    }

    console.log('ğŸ” DEBUG: handleItemStatusChange called:', {
      orderId,
      itemId: itemIdentifier,
      itemLineId: item.lineId,
      itemCode: item.itemCode,
      generatedId: item.id,
      oldStatus: item.itemStatus,
      newStatus: newStatus,
      materialCode: item.materialCode,
      quantity: item.quantity
    });

    setUpdatingItemIds(prev => [...new Set([...prev, item.id])])

    try {
      // Directly call the stock update logic if becoming delivered
      const isBecomingDelivered = newStatus === 'Teslim Edildi' && item.itemStatus !== 'Teslim Edildi';
      
      console.log('ğŸ” DEBUG: Item status update check:', {
        newStatus: newStatus,
        oldStatus: item.itemStatus,
        isBecomingDelivered: isBecomingDelivered,
        materialCode: item.materialCode,
        quantity: item.quantity
      });

      // Update the order item using lineId as identifier (includes automatic stock update)
      await OrderItemService.updateItemDeliveryStatus(orderId, itemIdentifier, newStatus)
      
      console.log('âœ… Item status updated successfully')
      
      // Refresh orders to show updates
      await refreshOrders()
      console.log('âœ… Orders refreshed')

      if (selectedOrder && selectedOrder.id === orderId) {
        console.log('ğŸ”„ Updating selected order details...')
        const latestItems = await OrderItemsService.getOrderItems(orderId)
        console.log('ğŸ“¦ Latest items fetched:', latestItems.length, 'items')
        
        setSelectedOrder(prev => prev ? {
          ...prev,
          orderStatus: prev.orderStatus,
          items: latestItems
        } : prev)

        setSelectedOrderLoading(true)
        try {
          const refreshed = await getOrderWithItems(orderId)
          console.log('ğŸ”„ DEBUG: Order refreshed with status:', refreshed.orderStatus)
          setSelectedOrder(refreshed)
        } catch (detailError) {
          console.error('âŒ Detay gÃ¼ncellenirken hata:', detailError)
        } finally {
          setSelectedOrderLoading(false)
        }
      }
    } catch (error) {
      console.error('âŒ Error updating item status:', error)
    } finally {
      setUpdatingItemIds(prev => prev.filter(id => id !== item.id))
    }
  }

  return (
    <div className="stocks-tab-content">
      <div className="materials-header-section">
        {!isFiltersExpanded && (
          <>
            <div className="materials-dashboard-container">
              <OrdersDashboard 
                stats={isInOfflineMode ? { pendingOrders: 0, thisMonthOrders: 0, partialOrders: 0 } : stats} 
                loading={isInOfflineMode ? false : statsLoading} 
              />
            </div>
            <div className="materials-actions-container">
              <div className="materials-actions">
                <button 
                  type="button" 
                  className="add-material-btn"
                  onClick={() => {
                    console.log('ğŸ”¥ğŸ”¥ğŸ”¥ Yeni SipariÅŸ butonu tÄ±klandÄ±!');
                    setIsAddOrderModalOpen(true);
                    console.log('ğŸ”¥ğŸ”¥ğŸ”¥ Modal aÃ§Ä±lmasÄ± iÃ§in state gÃ¼ncellendi!');
                  }}
                  disabled={actionLoading}
                >
                  + Yeni SipariÅŸ
                </button>
              </div>
            </div>
          </>
        )}
        <div className="materials-filters-container">
          <OrdersFilters 
            filters={filters}
            onFilterChange={handleFilterChange}
            isExpanded={isFiltersExpanded}
            onToggleExpanded={setIsFiltersExpanded}
            resultsCount={currentOrders.length}
            hasActiveFilters={hasActiveFilters()}
          />
        </div>
      </div>

      <OrdersTable 
        orders={isInOfflineMode ? [] : currentOrders}
        loading={false} // Always false to ensure tabs render
        error={hasFirebaseError ? ordersError : null}
        variant={activeOrdersTab}
        tabCounts={{ pending: isInOfflineMode ? 0 : pendingOrdersView.length, completed: isInOfflineMode ? 0 : completedOrdersView.length }}
        onChangeTab={setActiveOrdersTab}
        onOrderClick={handleOrderClick}
        onUpdateOrderStatus={handleUpdateOrderStatus}
        actionLoading={actionLoading}
        emptyMessage={
          hasFirebaseError 
            ? "ğŸŒ BaÄŸlantÄ± sorunu - Firebase'e eriÅŸilemiyor. LÃ¼tfen sayfayÄ± yenileyin veya internet baÄŸlantÄ±nÄ±zÄ± kontrol edin."
            : isInOfflineMode
              ? "âš ï¸ Veriler yÃ¼klenemedi - lÃ¼tfen tekrar deneyin"
              : activeOrdersTab === 'pending' 
                ? "Bekleyen sipariÅŸ bulunamadÄ±" 
                : "Tamamlanan sipariÅŸ bulunamadÄ±"
        }
      />

      {/* Add Order Modal */}
      <AddOrderModal 
        isOpen={isAddOrderModalOpen}
        onClose={() => setIsAddOrderModalOpen(false)}
        onSave={(newOrder) => {
          console.log('âœ… New order created:', newOrder);
          refreshOrders();
        }}
      />

      {/* TODO: Order Detail Modal */}
      {selectedOrder && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000
        }}>
          <div style={{
            background: 'white',
            padding: '0',
            borderRadius: '8px',
            maxWidth: '720px',
            width: '90%',
            maxHeight: '80vh',
            overflow: 'hidden',
            color: '#1f2937',
            display: 'flex',
            flexDirection: 'column',
            boxShadow: '0 10px 35px rgba(15, 23, 42, 0.25)'
          }}>
            <div style={{
              padding: '18px 24px',
              borderBottom: '1px solid #e5e7eb',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              background: '#f8fafc'
            }}>
              <div>
                <h3 style={{ margin: 0, fontSize: '18px', fontWeight: '700' }}>SipariÅŸ DetayÄ±</h3>
                <p style={{ margin: '6px 0 0', fontSize: '13px', color: '#6b7280' }}>
                  {selectedOrder.orderCode || selectedOrder.id}
                </p>
                <div style={{ marginTop: '10px' }}>
                  <select
                    value={selectedOrder.orderStatus || 'Onay Bekliyor'}
                    disabled={selectedOrderLoading || actionLoading}
                    onChange={(e) => handleUpdateOrderStatus(selectedOrder.id, e.target.value)}
                    style={{
                      padding: '6px 10px',
                      fontSize: '12px',
                      border: '1px solid #d1d5db',
                      borderRadius: '6px',
                      background: '#fff'
                    }}
                  >
                    {ORDER_STATUS_OPTIONS.map(status => (
                      <option key={status} value={status}>{status}</option>
                    ))}
                  </select>
                </div>
              </div>
              <button
                onClick={handleCloseOrderDetail}
                style={{
                  border: '1px solid #d1d5db',
                  background: 'white',
                  color: '#1f2937',
                  padding: '6px 14px',
                  borderRadius: '999px',
                  fontSize: '13px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
              >
                Kapat Ã—
              </button>
            </div>

            <div style={{ padding: '20px 24px 0', overflowY: 'auto' }}>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '16px',
                marginBottom: '20px'
              }}>
                <div>
                  <div style={{ fontSize: '12px', color: '#64748b', fontWeight: '600', textTransform: 'uppercase' }}>TedarikÃ§i</div>
                  <div style={{ fontSize: '14px', fontWeight: '600', marginTop: '4px' }}>{selectedOrder.supplierName}</div>
                </div>
                <div>
                  <div style={{ fontSize: '12px', color: '#64748b', fontWeight: '600', textTransform: 'uppercase' }}>Durum</div>
                  <div style={{ fontSize: '14px', fontWeight: '600', marginTop: '4px' }}>{selectedOrder.orderStatus}</div>
                </div>
                <div>
                  <div style={{ fontSize: '12px', color: '#64748b', fontWeight: '600', textTransform: 'uppercase' }}>Toplam</div>
                  <div style={{ fontSize: '16px', fontWeight: '700', color: '#059669', marginTop: '4px' }}>
                    {new Intl.NumberFormat('tr-TR', {
                      style: 'currency',
                      currency: 'TRY'
                    }).format(selectedOrder.totalAmount || 0)}
                  </div>
                </div>
              </div>

              <div style={{ marginBottom: '18px' }}>
                <h4 style={{ marginBottom: '10px', fontSize: '15px', fontWeight: '700' }}>
                  SipariÅŸ Kalemleri ({selectedOrder.items?.length || selectedOrder.itemCount || 0})
                </h4>
              {selectedOrderLoading ? (
                <p style={{ padding: '12px 0', color: '#6b7280' }}>Kalemler yÃ¼kleniyor...</p>
              ) : selectedOrderError ? (
                <p style={{ color: '#dc2626', padding: '12px 0' }}>Kalemler yÃ¼klenemedi: {selectedOrderError}</p>
              ) : (selectedOrder.items && selectedOrder.items.length > 0) ? (
                <div style={{
                  border: '1px solid #e5e7eb',
                  borderRadius: '6px',
                  overflow: 'hidden',
                  background: 'white'
                }}>
                  {console.log('ğŸ” DEBUG: Rendering order items:', selectedOrder.items.length, 'items')}
                  {[...(selectedOrder.items || [])]
                    .sort((a, b) => (a.itemSequence || 0) - (b.itemSequence || 0))
                    .map((item, index) => {
                      const isItemUpdating = updatingItemIds.includes(item.id);
                      console.log('ğŸ” DEBUG: Rendering item:', {
                        itemId: item.id,
                        itemStatus: item.itemStatus,
                        materialCode: item.materialCode,
                        hasId: !!item.id,
                        isUpdating: isItemUpdating
                      });
                      return (
                        <div
                          key={item.id || item.itemCode || index}
                          style={{
                            padding: '12px 14px',
                            background: index % 2 === 0 ? '#f9fafb' : 'white',
                            borderBottom: index < selectedOrder.items.length - 1 ? '1px solid #f1f5f9' : 'none'
                          }}
                        >
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '16px' }}>
                            <div style={{ flex: 1 }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px', flexWrap: 'wrap' }}>
                                <div style={{ fontSize: '12px', color: '#3b82f6', fontWeight: '600', minWidth: '56px' }}>
                                  {item.itemCode || item.lineId || `item-${String(index + 1).padStart(2, '0')}`}
                                </div>
                                <div style={{ fontSize: '12px', color: '#6366f1', fontWeight: '600', background: '#eef2ff', padding: '2px 6px', borderRadius: '999px' }}>
                                  {item.itemStatus || 'Onay Bekliyor'}
                                </div>
                                <select
                                  value={item.itemStatus || 'Onay Bekliyor'}
                                  disabled={selectedOrderLoading || !item.id || isItemUpdating || actionLoading}
                                  onChange={(e) => {
                                    const itemIdentifier = item.lineId || item.itemCode || item.id;
                                    console.log('ğŸ” DEBUG: Dropdown onChange triggered:', {
                                      itemId: itemIdentifier,
                                      itemLineId: item.lineId,
                                      itemCode: item.itemCode,
                                      generatedId: item.id,
                                      oldStatus: item.itemStatus,
                                      newStatus: e.target.value,
                                      materialCode: item.materialCode
                                    });
                                    console.log('ğŸ” DEBUG: Dropdown disabled state check:', {
                                      selectedOrderLoading,
                                      hasItemId: !!item.id,
                                      isItemUpdating,
                                      actionLoading,
                                      totalDisabled: selectedOrderLoading || !item.id || isItemUpdating || actionLoading
                                    });
                                    handleItemStatusChange(selectedOrder.id, item, e.target.value);
                                  }}
                                  style={{
                                    padding: '4px 8px',
                                    fontSize: '11px',
                                    border: '1px solid #d1d5db',
                                    borderRadius: '4px',
                                    background: '#fff'
                                  }}
                                >
                                  {ITEM_STATUS_OPTIONS.map(status => (
                                    <option key={status} value={status}>{status}</option>
                                  ))}
                                </select>
                              </div>
                              <div style={{ fontWeight: '600', marginBottom: '2px' }}>{item.materialName || '-'}</div>
                              <div style={{ fontSize: '12px', color: '#6b7280' }}>
                                {item.materialCode || 'â€”'} â€¢ {item.quantity || 0} adet Ã— {new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(item.unitPrice || 0)}
                              </div>
                              {item.expectedDeliveryDate && (
                                <div style={{ fontSize: '11px', color: '#94a3b8', marginTop: '4px' }}>
                                  Beklenen Teslim: {item.expectedDeliveryDate instanceof Date ? item.expectedDeliveryDate.toLocaleDateString('tr-TR') : item.expectedDeliveryDate}
                                </div>
                              )}
                            </div>
                            <div style={{ fontWeight: '600', fontSize: '14px', minWidth: '90px', textAlign: 'right' }}>
                              {new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format((item.quantity || 0) * (item.unitPrice || 0))}
                            </div>
                          </div>
                        </div>
                      )
                    })}
                </div>
              ) : (
                <p style={{ color: '#6b7280', fontStyle: 'italic' }}>Bu sipariÅŸ iÃ§in kayÄ±tlÄ± kalem bulunamadÄ±.</p>
              )}
            </div>
          </div>
        </div>
      </div>
      )}
    </div>
  )
}
